name: Release

on:
  push:
    tags:
      - '*'

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven
          server-id: central
          server-username: CENTRAL_USERNAME
          server-password: CENTRAL_PASSWORD

      - name: Validate Central credentials
        run: |
          if [ -z "${{ secrets.CENTRAL_USERNAME }}" ]; then
            echo "‚ùå Missing secret: CENTRAL_USERNAME (Sonatype Token Name)"
            exit 1
          fi
          if [ -z "${{ secrets.CENTRAL_PASSWORD }}" ]; then
            echo "‚ùå Missing secret: CENTRAL_PASSWORD (Sonatype Token Value)"
            exit 1
          fi
          echo "‚úÖ Sonatype credentials detected."

      - name: Set version from tag
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "Setting version to $VERSION"
          mvn versions:set -DnewVersion=$VERSION -B -ntp

      - name: Verify Maven server config
        run: |
          echo "Active Maven server configuration:"
          cat ~/.m2/settings.xml | grep -A5 "<server>"

      - name: Build and publish (debug mode)
        env:
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
          CENTRAL_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
          CENTRAL_PASSWORD: ${{ secrets.CENTRAL_PASSWORD }}
        run: |
          echo "üöÄ Starting Maven deploy with debug logs..."
          mvn -X -B -ntp clean verify deploy -DskipTests

      - name: Confirm deployment success
        if: success()
        run: echo "‚úÖ Deployment completed successfully!"